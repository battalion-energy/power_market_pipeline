# DETAILED MATCHING PROCESS TRACE

## ⚠️ CRITICAL ISSUE IDENTIFIED
The current matching process is producing FALSE POSITIVES. Example: IKEA rooftop solar (1.2 MW) is being matched to large battery systems and wind farms.

## Data Sources and Exact Columns Used

### 1. ERCOT 60-Day DAM Disclosure Data
**File**: `/pool/ssd8tb/data/iso/ERCOT/ercot_market_data/ERCOT_data/60-Day_DAM_Disclosure_Reports/csv/60d_DAM_Gen_Resource_Data-18-JAN-24.csv`

**Columns Used**:
- `Resource Name` - The ERCOT resource identifier (e.g., "ANCHOR_BESS1", "FORMOSA_CC1_1")

**Processing**:
1. Extract unique values from `Resource Name` column
2. Split on underscore to get base code (e.g., "ANCHOR_BESS1" → "ANCHOR")
3. Total: 1,278 unique resources, 504 unique base codes

### 2. LLM-Generated Mappings
**File**: `ercot_code_mappings.py`

**Function**: `get_plant_name(code)`
- Input: ERCOT base code (e.g., "ANCHOR")
- Output: Decoded plant name (e.g., "Anchor Battery Energy Storage System")
- Total: 393 mappings generated by Claude

**Example Mappings**:
```python
'ANCHOR': 'Anchor Battery Energy Storage System',
'FORMOSA': 'Formosa Plastics Corporation Cogeneration Plant',
'THW': 'T.H. Wharton Generating Station'
```

### 3. Interconnection Queue Data
**File**: `/pool/ssd8tb/data/iso/ERCOT/ercot_market_data/ERCOT_data/ERCOT_InterconnectionQueue/interconnection_gis_report.xlsx`

#### Tab: "Project Details - Large Gen"
**Skip Rows**: 30
**Columns Used**:
- `INR` - Interconnection Request Number (filter: not null)
- `Project Name` - Full project name
- `County` - Texas county name
- `Capacity (MW)` - Project capacity
- `Fuel` - Fuel type
- `Technology` - Generation technology
- `POI Location` - Point of interconnection (text description, NO LAT/LON)

**Records**: 1,849 projects after filtering

#### Tab: "Project Details - Small Gen"
**Skip Rows**: 14
**Columns Used**: Same as Large Gen
**Records**: 56 projects after filtering

**Total IQ Projects**: 1,905

### 4. EIA Plant Database
**File**: `/home/enrico/experiments/ERCOT_SCED/pypsa-usa/workflow/repo_data/plants/eia860_ads_merged.csv`

**Columns Used**:
- `plant_code` - EIA plant ID
- `plant_name` - Full plant name
- `state` - Filtered to 'TX' only
- `latitude` - Plant latitude
- `longitude` - Plant longitude
- `nameplate_capacity_mw` - Plant capacity
- `county` - County name (NOTE: Column doesn't exist in file!)

**Processing**:
1. Filter to `state == 'TX'`
2. Group by `plant_code` and aggregate:
   - `plant_name`: first
   - `latitude`: first
   - `longitude`: first
   - `nameplate_capacity_mw`: sum
3. Total: 755 unique Texas plants

### 5. Settlement Point Mapping
**File**: `/pool/ssd8tb/data/iso/ERCOT/ercot_market_data/ERCOT_data/Settlement_Points_List_and_Electrical_Buses_Mapping/latest_mapping/SP_List_EB_Mapping/gen_node_map.csv`

**Columns Used**:
- `RESOURCE_NODE` - ERCOT resource name
- `UNIT_SUBSTATION` - Substation name
- `UNIT_NAME` - Unit name

**Coverage**: Only 77 of 1,278 resources found (6%)

### 6. Settlement Points to Load Zones
**File**: `/pool/ssd8tb/data/iso/ERCOT/ercot_market_data/ERCOT_data/Settlement_Points_List_and_Electrical_Buses_Mapping/latest_mapping/SP_List_EB_Mapping/Settlement_Points_07242024_210751.csv`

**Columns Used**:
- `SUBSTATION` - Substation name
- `SETTLEMENT_LOAD_ZONE` - Load zone

## MATCHING ALGORITHM FLOW

### Step 1: Decode ERCOT Code
```
Input: "ANCHOR_BESS1"
Extract base: "ANCHOR"
LLM decode: "Anchor Battery Energy Storage System"
```

### Step 2: Direct EIA Match (PROBLEM HERE!)
```python
def find_best_eia_match(decoded_name, eia_plants, threshold=0.3):
    # Normalizes both names removing common words
    # "Anchor Battery Energy Storage System" → "ANCHOR"
    # "IKEA Grand Prairie Rooftop PV System" → "IKEA GRAND PRAIRIE ROOFTOP PV"
    
    # Token matching finds "SYSTEM" in both
    # Score = 0.5 (above 0.3 threshold)
    # FALSE MATCH!
```

**THE PROBLEM**: 
- No capacity validation (IKEA: 1.2 MW vs ANCHOR: likely 100+ MW)
- No county validation
- Token matching too loose
- Common words like "System" causing false matches

### Step 3: IQ Match (If no EIA match)
```python
# Matches decoded name to IQ Project Name
# Then tries to match IQ to EIA
# Same problems as above
```

## FALSE POSITIVE EXAMPLES

| ERCOT Resource | Decoded Name | Matched to | EIA MW | Problem |
|----------------|--------------|------------|--------|---------|
| ANCHOR_BESS1 | Anchor Battery Energy Storage System | IKEA Grand Prairie | 1.2 | Wrong type & size |
| ALVIN_UNIT1 | Alvin Battery Energy Storage System | IKEA Grand Prairie | 1.2 | Wrong type & size |
| ANGLETON_UNIT1 | Angleton Battery Energy Storage System | IKEA Grand Prairie | 1.2 | Wrong type & size |
| REROCK_UNIT1 | Red Rock Wind Farm | IKEA Round Rock | 1.4 | Wind ≠ Solar |

## MISSING VALIDATION

### What's NOT Being Checked:
1. **Capacity Validation**: BESS systems are typically 10-200 MW, not 1.2 MW
2. **County Validation**: No county column in EIA aggregation
3. **Technology Type**: Matching wind to solar, batteries to rooftop PV
4. **Commercial Operation Date**: Matching new BESS to old solar installations

### What SHOULD Be Checked:
1. Capacity within reasonable range (±30% or at least same order of magnitude)
2. County match between IQ and EIA
3. Technology type compatibility
4. Year of commercial operation

## RECOMMENDED FIXES

1. **Add Capacity Validation**:
   ```python
   if abs(ercot_capacity - eia_capacity) / max(ercot_capacity, eia_capacity) > 0.5:
       return None  # Reject match if capacity differs by >50%
   ```

2. **Add County Validation**:
   ```python
   if iq_county and eia_county and iq_county != eia_county:
       return None  # Reject if counties don't match
   ```

3. **Add Technology Type Validation**:
   ```python
   if 'Battery' in decoded_name and 'Solar' in eia_plant_name:
       return None  # Reject technology mismatches
   ```

4. **Increase Match Threshold**:
   - Current: 0.3
   - Recommended: 0.6 for direct matches, 0.5 for IQ matches

5. **Remove Common Words More Aggressively**:
   ```python
   very_common = ['SYSTEM', 'PLANT', 'FACILITY', 'ENERGY', 'POWER']
   ```

## CONCLUSION

The current matching is producing severe false positives because:
1. **No capacity validation** - Matching 100+ MW batteries to 1.2 MW rooftop solar
2. **Token matching too loose** - "System" appears in many names
3. **No technology type checking** - Wind matching to solar
4. **Missing county validation** - Not using geographic constraints

This explains why 68.2% match rate is TOO HIGH and includes many false matches.