# Resource to Settlement Point Mapping Documentation

## Overview
This document describes the resource-to-settlement point mapping system used in the ERCOT power market pipeline for mapping generation and load resources to their corresponding settlement points for price matching and revenue calculation.

## Data Sources

### Primary Mapping File
**Location**: `/home/enrico/data/ERCOT_data/Settlement_Points_List_and_Electrical_Buses_Mapping/latest_mapping/SP_List_EB_Mapping/gen_node_map.csv`

**Structure**:
```csv
RESOURCE_NODE,UNIT_SUBSTATION,UNIT_NAME
7RNCHSLR_ALL,7RNCHSLR,UNIT1
BATCAVE_BES1,BATCAVE,BES1
RRANCHES_UNIT1,RRANCHES,UNIT1
```

**Fields**:
- `RESOURCE_NODE`: The settlement point identifier used in price files
- `UNIT_SUBSTATION`: The electrical substation/bus location
- `UNIT_NAME`: The generation or load resource name

### Secondary Sources

1. **BESS Resource Mapping** (Generated)
   - File: `bess_resource_mapping.csv`
   - Contains battery-specific mappings including gen/load resource relationships
   - Generated by: `extract_bess_resource_mapping.py`

2. **60-Day Disclosure Data**
   - DAM/SCED Gen Resources contain `SettlementPointName` columns
   - Used for validation and cross-referencing

## Mapping Methodology

### Resource Name â†’ Settlement Point
The mapping follows this hierarchy:

1. **Direct Lookup**: Check `gen_node_map.csv` for exact UNIT_NAME match
2. **Fallback to Resource Data**: Use SettlementPointName from DAM/SCED files
3. **Hub Average**: If no specific point found, use `HB_BUSAVG` for pricing

### BESS-Specific Considerations

ERCOT splits Battery Energy Storage Systems (BESS) into two resources:
- **Generation Resource** (e.g., `BATCAVE_BES1`): Handles discharging
- **Load Resource** (e.g., `BATCAVE_LD1`): Handles charging (for AS only)

Both typically map to the same settlement point for pricing.

## Price File Integration

### Day-Ahead (DA) Prices
**File Pattern**: `DAM_SPP_YYYY.csv`
**Settlement Point Column**: `SettlementPoint`
**Price Column**: `SettlementPointPrice`

Example:
```csv
DeliveryDate,HourEnding,SettlementPoint,SettlementPointPrice
12/03/2010,01:00,BATCAVE_BES1,24.75
```

### Real-Time (RT) Prices
**File Pattern**: `SPPHLZNP_YYYYMMDD.csv`
**Settlement Point Column**: `SettlementPointName`
**Price Column**: `SettlementPointPrice`

Example:
```csv
DeliveryDate,DeliveryHour,DeliveryInterval,SettlementPointName,SettlementPointPrice
01/01/2024,1,0,BATCAVE_BES1,25.43
```

## Database Schema (If Implemented)

### Proposed Table: `resource_settlement_mapping`
```sql
CREATE TABLE resource_settlement_mapping (
    id SERIAL PRIMARY KEY,
    resource_name TEXT NOT NULL,
    settlement_point TEXT NOT NULL,
    resource_type TEXT, -- 'GEN', 'LOAD', 'VIRTUAL'
    unit_substation TEXT,
    eia_id TEXT, -- EIA plant ID if available
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(resource_name)
);

-- Index for fast lookups
CREATE INDEX idx_resource_name ON resource_settlement_mapping(resource_name);
CREATE INDEX idx_settlement_point ON resource_settlement_mapping(settlement_point);
```

### Data Population
```sql
-- Example insert from gen_node_map.csv
INSERT INTO resource_settlement_mapping (resource_name, settlement_point, unit_substation)
SELECT UNIT_NAME, RESOURCE_NODE, UNIT_SUBSTATION
FROM staging_gen_node_map;
```

## Usage in Revenue Calculations

### Python Example
```python
# Load mapping
mapping_df = pd.read_csv('gen_node_map.csv')
unit_to_sp = dict(zip(mapping_df['UNIT_NAME'], mapping_df['RESOURCE_NODE']))

# Map resource to settlement point
resource_name = 'BATCAVE_BES1'
settlement_point = unit_to_sp.get(resource_name, 'HB_BUSAVG')  # Fallback to hub

# Get price for that settlement point
price = da_prices_df[da_prices_df['SettlementPoint'] == settlement_point]['Price'].iloc[0]

# Calculate revenue
revenue = award_mw * price
```

### Key Challenges

1. **Missing Mappings**: Some resources may not have settlement points in mapping file
   - Solution: Use SettlementPointName from resource data or hub average

2. **Name Inconsistencies**: Resource names may vary between files
   - Example: `BATCAVE_BES1` vs `BATCAVE_BESS1`
   - Solution: Implement fuzzy matching or standardization

3. **Multiple Settlement Points**: Some resources may have multiple pricing nodes
   - Solution: Use primary node or weighted average

## Validation Checks

1. **Coverage Check**: Verify all active resources have mappings
```python
unmapped = gen_resources[~gen_resources['ResourceName'].isin(unit_to_sp.keys())]
print(f"Unmapped resources: {len(unmapped)}")
```

2. **Price Availability**: Ensure settlement points exist in price files
```python
missing_prices = settlement_points - set(price_df['SettlementPoint'])
print(f"Settlement points without prices: {len(missing_prices)}")
```

3. **Consistency Check**: Verify gen/load pairs map to same settlement point
```python
for base_name in battery_mapping:
    gen_sp = unit_to_sp.get(f"{base_name}_UNIT1")
    load_sp = unit_to_sp.get(f"{base_name}_LD1")
    if gen_sp != load_sp:
        print(f"Mismatch: {base_name} gen={gen_sp}, load={load_sp}")
```

## EIA Mapping (Future Enhancement)

The Energy Information Administration (EIA) plant codes could be added for federal reporting integration:

```csv
RESOURCE_NAME,SETTLEMENT_POINT,EIA_PLANT_ID,EIA_GENERATOR_ID
BATCAVE_BES1,BATCAVE_BES1,12345,1
```

This would enable:
- Cross-referencing with EIA-860 and EIA-923 data
- Capacity and generation validation
- Ownership tracking

## Maintenance

### Update Frequency
- Settlement point mappings: Check monthly for new resources
- BESS mappings: Regenerate when new batteries come online
- Database sync: Daily or as needed

### Data Sources for Updates
1. ERCOT Network Model updates
2. New resource integration reports
3. 60-Day Disclosure data scanning

## References

- ERCOT Market Information System: [mis.ercot.com](http://mis.ercot.com)
- ERCOT Nodal Protocols: Section 4.4 (Settlement Points)
- EIA Electric Power Data: [eia.gov/electricity](https://www.eia.gov/electricity/)