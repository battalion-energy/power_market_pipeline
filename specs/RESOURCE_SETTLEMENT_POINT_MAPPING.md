# Resource to Settlement Point Mapping Documentation

## Overview
This document describes the resource-to-settlement point mapping system used in the ERCOT power market pipeline for mapping generation and load resources to their corresponding settlement points for price matching and revenue calculation.

## Data Sources

### Primary Mapping Files
**Location**: `/pool/ssd8tb/data/iso/ERCOT/ercot_market_data/ERCOT_data/Settlement_Points_List_and_Electrical_Buses_Mapping/latest_mapping/SP_List_EB_Mapping/`

1. **Resource Node to Unit Mapping**
   - File: `Resource_Node_to_Unit_07242024_210751.csv`
   - Symlink: `gen_node_map.csv`
   
2. **Settlement Points Master List**
   - File: `Settlement_Points_07242024_210751.csv`
   - Contains all settlement points with zones and substations

**Structure**:
```csv
RESOURCE_NODE,UNIT_SUBSTATION,UNIT_NAME
7RNCHSLR_ALL,7RNCHSLR,UNIT1
BATCAVE_BES1,BATCAVE,BES1
RRANCHES_UNIT1,RRANCHES,UNIT1
```

**Fields**:
- `RESOURCE_NODE`: The settlement point identifier used in price files
- `UNIT_SUBSTATION`: The electrical substation/bus location
- `UNIT_NAME`: The generation or load resource name

### Secondary Sources

1. **BESS Resource Mapping** (Generated)
   - File: `bess_resource_mapping.csv`
   - Contains battery-specific mappings including gen/load resource relationships
   - Generated by: `extract_bess_resource_mapping.py`

2. **BESS Comprehensive Mapping with Coordinates** (Latest)
   - File: `BESS_COMPREHENSIVE_WITH_COORDINATES.csv`
   - Contains 209 BESS resources with 95 columns
   - Includes geographic coordinates (81.3% coverage)
   - Full IQ and EIA data integration
   - Generated by: `create_bess_mapping_with_coordinates.py`

3. **60-Day Disclosure Data**
   - DAM/SCED Gen Resources contain `SettlementPointName` columns
   - Used for validation and cross-referencing

## Mapping Methodology

### Resource Name → Settlement Point
The mapping follows this hierarchy:

1. **Direct Lookup**: Check `gen_node_map.csv` for exact UNIT_NAME match
2. **Fallback to Resource Data**: Use SettlementPointName from DAM/SCED files
3. **Hub Average**: If no specific point found, use `HB_BUSAVG` for pricing

### BESS-Specific Considerations

ERCOT splits Battery Energy Storage Systems (BESS) into two resources:
- **Generation Resource** (e.g., `BATCAVE_BES1`): Handles discharging
- **Load Resource** (e.g., `BATCAVE_LD1`): Handles charging

#### Verified BESS Naming Patterns

After comprehensive analysis of 195 BESS resources in ERCOT (as of 2024), we've identified and verified these naming patterns:

1. **Same Name Pattern** (18% of BESS)
   - Gen and Load use identical names
   - Example: `BAY_CITY_BESS` → `BAY_CITY_BESS`
   
2. **_BES{N} → _LD{N} Pattern** (15% of BESS)
   - Replace `_BES` with `_LD`
   - Example: `BATCAVE_BES1` → `BATCAVE_LD1`
   
3. **_BESS{N} → _LD{N} Pattern** (45% of BESS)
   - Replace `_BESS` with `_LD`
   - Example: `ANCHOR_BESS1` → `ANCHOR_LD1`
   
4. **_UNIT{N} → _LD{N} Pattern** (22% of BESS)
   - Replace `_UNIT` with `_LD`
   - Example: `ALVIN_UNIT1` → `ALVIN_LD1`

#### IMPORTANT: Real Data Only Policy

**CRITICAL**: We use ONLY verified Load Resources that actually exist in ERCOT data. We NEVER predict or invent Load Resource names based on patterns.

#### Verification Results (Real Data Only)

From comprehensive verification against actual ERCOT data (December 2024):
- **209 total BESS resources** identified in ERCOT system (expanded coverage)
- **62.9% (124)** have VERIFIED Load Resources found in actual ERCOT CSV files
- **37.1% (73)** have NO Load Resource found in ERCOT data
- **Data sources verified**: 4,933 DAM files and 1,855 SCED files
- **1,654 unique real Load Resources** identified in ERCOT data
- **95.4% (188)** successfully mapped to substations
- **100%** coverage for all operational zones (LZ_WEST, LZ_SOUTH, LZ_NORTH, LZ_HOUSTON)
- **81.3% (170)** now have geographic coordinates (lat/long)

**CRITICAL CLARIFICATION - Why 73 BESS Lack Load Resources:**

| Reason | Count | Percentage | Explanation |
|--------|-------|------------|-------------|
| **Planned Projects** | 58 | 79.5% | Not yet operational (COD 2025-2029), will get Load Resource when built |
| **Co-located Operational** | 9 | 12.3% | Charge directly from solar/wind, don't need market Load Resource |
| **Unknown Status** | 6 | 8.2% | Status unclear |

**Key Insight:** Co-located BESS that charge from renewable generation:
- Don't need DAM/RTM Load Resource registration
- Avoid transmission charges and grid losses
- Use curtailed renewable energy
- Examples: BIG_STAR_BESS (solar), BLSUMMIT_BATTERY (wind)

#### Complete BESS Mapping Tables

**Real Data Only Version**: `BESS_RESOURCE_MAPPING_REAL_ONLY.csv`
- Contains ONLY verified Load Resources from actual ERCOT data
- NULL/blank for BESS without verified Load Resources
- Generated by: `create_bess_resource_mapping_REAL_ONLY.py`

**Pattern-Based Version (DEPRECATED)**: `BESS_RESOURCE_MAPPING.csv`
- DO NOT USE - contains predicted Load Resource names
- Kept for historical reference only

Contents of Real Data Mapping:
- `BESS_Gen_Resource`: Generation resource name (verified from DAM data)
- `BESS_Load_Resource`: Load resource name (ONLY if verified in ERCOT data, otherwise NULL)
- `Settlement_Point`: Settlement point for pricing
- `Substation`: Physical substation connection
- `Load_Zone`: ERCOT load zone

Both Gen and Load resources typically map to the same settlement point for pricing.

## Price File Integration

### Day-Ahead (DA) Prices
**File Pattern**: `DAM_SPP_YYYY.csv`
**Settlement Point Column**: `SettlementPoint`
**Price Column**: `SettlementPointPrice`

Example:
```csv
DeliveryDate,HourEnding,SettlementPoint,SettlementPointPrice
12/03/2010,01:00,BATCAVE_BES1,24.75
```

### Real-Time (RT) Prices
**File Pattern**: `SPPHLZNP_YYYYMMDD.csv`
**Settlement Point Column**: `SettlementPointName`
**Price Column**: `SettlementPointPrice`

Example:
```csv
DeliveryDate,DeliveryHour,DeliveryInterval,SettlementPointName,SettlementPointPrice
01/01/2024,1,0,BATCAVE_BES1,25.43
```

## Database Schema (If Implemented)

### Proposed Table: `resource_settlement_mapping`
```sql
CREATE TABLE resource_settlement_mapping (
    id SERIAL PRIMARY KEY,
    resource_name TEXT NOT NULL,
    settlement_point TEXT NOT NULL,
    resource_type TEXT, -- 'GEN', 'LOAD', 'VIRTUAL'
    unit_substation TEXT,
    eia_id TEXT, -- EIA plant ID if available
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(resource_name)
);

-- Index for fast lookups
CREATE INDEX idx_resource_name ON resource_settlement_mapping(resource_name);
CREATE INDEX idx_settlement_point ON resource_settlement_mapping(settlement_point);
```

### Data Population
```sql
-- Example insert from gen_node_map.csv
INSERT INTO resource_settlement_mapping (resource_name, settlement_point, unit_substation)
SELECT UNIT_NAME, RESOURCE_NODE, UNIT_SUBSTATION
FROM staging_gen_node_map;
```

## Usage in Revenue Calculations

### Python Example - Using Real BESS Mapping
```python
import pandas as pd

# IMPORTANT: Use ONLY the real data mapping
# DO NOT predict Load Resource names with patterns
bess_mapping = pd.read_csv('BESS_RESOURCE_MAPPING_REAL_ONLY.csv')

# Example: Get all info for a BESS
bess_name = 'BATCAVE_BES1'
bess_info = bess_mapping[bess_mapping['BESS_Gen_Resource'] == bess_name].iloc[0]

gen_resource = bess_info['BESS_Gen_Resource']  # BATCAVE_BES1
# IMPORTANT: Load resource might be NULL if not found in real ERCOT data
load_resource = bess_info['BESS_Load_Resource']  # BATCAVE_LD1 or NaN
settlement_point = bess_info['Settlement_Point']  # BATCAVE_RN
substation = bess_info['Substation']  # BATCAVE
load_zone = bess_info['Load_Zone']  # LZ_SOUTH

# Check if Load Resource actually exists before using it
if pd.notna(load_resource):
    # Load Resource verified to exist in ERCOT data
    print(f"Using verified Load Resource: {load_resource}")
else:
    # No Load Resource found in real ERCOT data
    print(f"No Load Resource found for {gen_resource}")
    # Handle accordingly - maybe only use Gen resource data

# Get price for settlement point
price = da_prices_df[da_prices_df['SettlementPoint'] == settlement_point]['Price'].iloc[0]

# Calculate revenue (with both Gen and Load components)
gen_revenue = gen_award_mw * price
load_cost = load_consumption_mw * price
net_revenue = gen_revenue - load_cost
```

### Key Challenges

1. **Missing Mappings**: Some resources may not have settlement points in mapping file
   - Solution: Use SettlementPointName from resource data or hub average

2. **Name Inconsistencies**: Resource names may vary between files
   - Example: `BATCAVE_BES1` vs `BATCAVE_BESS1`
   - Solution: Implement fuzzy matching or standardization

3. **Multiple Settlement Points**: Some resources may have multiple pricing nodes
   - Solution: Use primary node or weighted average

## Validation Checks

1. **Coverage Check**: Verify all active resources have mappings
```python
unmapped = gen_resources[~gen_resources['ResourceName'].isin(unit_to_sp.keys())]
print(f"Unmapped resources: {len(unmapped)}")
```

2. **Price Availability**: Ensure settlement points exist in price files
```python
missing_prices = settlement_points - set(price_df['SettlementPoint'])
print(f"Settlement points without prices: {len(missing_prices)}")
```

3. **Consistency Check**: Verify gen/load pairs map to same settlement point
```python
for base_name in battery_mapping:
    gen_sp = unit_to_sp.get(f"{base_name}_UNIT1")
    load_sp = unit_to_sp.get(f"{base_name}_LD1")
    if gen_sp != load_sp:
        print(f"Mismatch: {base_name} gen={gen_sp}, load={load_sp}")
```

## EIA Mapping (Future Enhancement)

The Energy Information Administration (EIA) plant codes could be added for federal reporting integration:

```csv
RESOURCE_NAME,SETTLEMENT_POINT,EIA_PLANT_ID,EIA_GENERATOR_ID
BATCAVE_BES1,BATCAVE_BES1,12345,1
```

This would enable:
- Cross-referencing with EIA-860 and EIA-923 data
- Capacity and generation validation
- Ownership tracking

## BESS Mapping Generation Scripts

### Real Data Only Version (REQUIRED)

Generate verified BESS mapping using ONLY real ERCOT data:

```bash
python create_bess_resource_mapping_REAL_ONLY.py
```

This script:
1. Loads all BESS from DAM Gen Resources (PWRSTR type)
2. Scans thousands of ERCOT CSV files to find REAL Load Resources
3. Maps ONLY verified Load Resources (no predictions/patterns)
4. Maps to settlement points and substations using ERCOT mapping files
5. Outputs `BESS_RESOURCE_MAPPING_REAL_ONLY.csv` with verified data only

### Pattern-Based Version (DEPRECATED - DO NOT USE)

The old `create_bess_resource_mapping.py` script uses patterns to predict Load Resource names and should NOT be used as it creates fake data.

## Maintenance

### Update Frequency
- Settlement point mappings: Check monthly for new resources
- BESS mappings: Regenerate when new batteries come online (run `create_bess_resource_mapping_REAL_ONLY.py`)
- Database sync: Daily or as needed
- **IMPORTANT**: Always verify against real ERCOT data - never predict or invent resource names

### Data Sources for Updates
1. ERCOT Network Model updates
2. New resource integration reports
3. 60-Day Disclosure data scanning
4. DAM Gen Resources parquet files (for new BESS)

## Unified BESS Mapping (Latest Version)

### Complete Data Chain: `BESS_UNIFIED_MAPPING_V3_CLARIFIED.csv`

This comprehensive file provides the complete mapping chain:
**BESS → Settlement Point → Substation → Interconnection Queue → EIA Generator**

#### Key Features:
- **197 BESS resources** with **32+ data columns**
- **97% matched** to ERCOT Interconnection Queue projects
- **56% matched** to EIA Generator database
- **100% have** settlement point mappings

#### Critical Clarifications Added:

1. **`True_Operational_Status`** - Resolves confusion about operational status:
   - "Operational (has Load Resource)" - 124 BESS
   - "Planned (from Stand-Alone sheet)" - 37 BESS
   - "Operational (co-located, no Load Resource needed)" - 9 BESS

2. **`IQ_Source_Clarified`** - Explains misleading sheet names:
   - "Standalone" → "Planned Standalone (from Stand-Alone tab - 698/701 are PLANNED)"
   - Clarifies that "Stand-Alone" sheet contains PLANNED projects, not operational

3. **`Load_Resource_Explanation`** - Explains missing Load Resources:
   - "No Load Resource - Planned project (not yet operational)"
   - "No Load Resource - Operational co-located BESS charging from renewable"

### Understanding ERCOT Interconnection Queue Structure

**Critical Insight:** The Excel sheet names are misleading:

| Excel Sheet | What It Actually Contains | Status |
|-------------|---------------------------|---------|
| **Co-located Operational** | ALL operational BESS (both standalone and co-located) | Currently Operating |
| | - Fuel=OTH: Standalone operational BESS (50 units) | |
| | - Fuel=SOL: Solar co-located operational (51 units) | |
| | - Fuel=WIN: Wind co-located operational (21 units) | |
| **Stand-Alone** | PLANNED standalone BESS projects | 698/701 are Planned |
| **Co-located with Solar** | PLANNED solar+battery projects | Future Projects |
| **Co-located with Wind** | PLANNED wind+battery projects | Future Projects |

### Standalone vs Co-located BESS

**Only ~50 of 122 operational BESS are truly standalone.** The rest are co-located:

#### Operational BESS Breakdown:
- **50 Standalone** (Fuel=OTH): Charge from market, need Load Resources
- **51 Solar Co-located** (Fuel=SOL): Charge from solar, may not need Load Resources
- **21 Wind Co-located** (Fuel=WIN): Charge from wind, may not need Load Resources

#### Why Co-located BESS May Not Have Load Resources:
- Charge directly from renewable generation (not from market)
- Avoid transmission charges and grid losses
- Use excess/curtailed renewable energy
- Only need Generation Resource for discharge to market

### EIA Matching Challenges

**Why only 56% match to EIA:**

1. **Co-location Issue**: EIA reports co-located BESS under parent solar/wind plant
2. **Match Rates by Type**:
   - Standalone BESS: 59% match to EIA
   - Solar Co-located: Only 28% match
3. **Other Factors**: Reporting lag, small facility thresholds, naming differences

## References

- ERCOT Market Information System: [mis.ercot.com](http://mis.ercot.com)
- ERCOT Nodal Protocols: Section 4.4 (Settlement Points)
- EIA Electric Power Data: [eia.gov/electricity](https://www.eia.gov/electricity/)
- Unified Mapping Documentation: `specs/BESS_UNIFIED_MAPPING_DOCUMENTATION.md`